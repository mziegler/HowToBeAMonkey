function initMap(){function a(){L.Path.CLIP_PADDING=3e3}function b(){L.Path.CLIP_PADDING=f}function c(){e.getZoom()<=17&&e.closePopup(),e.getZoom()<=14}var d=[[10.5147,-85.3698],18],e=L.map("map",{maxZoom:19,zoomControl:!1,attributionControl:!1,maxBounds:L.latLngBounds([10.525,-85.3605],[10.5065,-85.3745])}).setView(d[0],d[1]);L.tileLayer("http://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",{maxZoom:19,opacity:1}).addTo(e);var f=L.Path.CLIP_PADDING;a();L.polyline(media.cabuyoPoints,{color:"lightblue",opacity:.7,weight:8,lineJoin:"round",lineCap:"round"}).addTo(e),L.polyline(media.pizotePoints,{color:"lightblue",opacity:.7,weight:5,lineJoin:"round",lineCap:"round"}).addTo(e),L.polyline(media.WHtrack,{color:"white",opacity:1,weight:5,lineJoin:"round",lineCap:"round",dashArray:[10,10]}).addTo(e);return b(),function(){function a(a){var b=a,c=e.getSize();return b>c.x-25&&(b=c.x-25),b}var b=null;e.on("popupopen",function(c){if(b=c.popup,b.options.fullWidth){var d=a(b.options.fullWidth);d<b.options.minWidth&&(b.options.minWidth=b.options.maxWidth=d,b.update())}}),e.on("resize",function(){e.hasLayer(b)&&b.options.fullWidth&&(b.options.minWidth=b.options.maxWidth=a(b.options.fullWidth),b.update())})}(),L.control.zoom({position:"topleft"}).addTo(e),L.control.scale().addTo(e),c(),e.on("zoomend",c),{map:e,animationLineClipPadding:a,resetLineClipPadding:b,initialView:d}}function initMediaOverlay(){function a(){$("#overlay-background").fadeOut("fast")}function b(a,b,c,d){a&&$("#overlay-title").html(a).addClass("filled"),b&&$("#overlay-caption").html(b).addClass("filled"),c&&$("#overlay-media").html('<img src="pictures/'+c+'">').addClass("filled"),map.map.closePopup(),$("#overlay-background").fadeIn()}return $("#overlay-background").click(a),{openOverlay:b,closeOverlay:a}}function initMapMedia(){function a(a,b){var c=$("#map").offset(),d=$(a).offset(),e=($(a).width(),L.point(d.left-c.left+b,d.top-c.top+5));return map.map.containerPointToLatLng(e)}function b(b,c){map.map.openPopup('<div class="popup-title">'+b.title.replace("\\n"," ")+'</div><div class="caption">'+b.text+"</div>",a(c,Math.min(b.r,b.value)),{className:"behavior-popup texbox-popup",maxWidth:500,minWidth:500,fullWidth:500,keepInView:!1}).on("click",function(){headerControls.closeSidePanel()}),headerControls.closeSidePanel()}function c(a){var b=a[0].category,c='<div class="popup-title popup-title-c'+b+'">'+media.categories[b].name+'</div><div class="behavior-list"><table><tbody class="behavior-points-initial">';a.sort(function(a,b){return b.rank-a.rank});for(var d=[],e={},f=0;f<a.length&&d.length<4;f++)e.hasOwnProperty(a[f].text)||(e[a[f].text]=!0,d.push(a[f]));d.sort(function(a,b){return a.time.localeCompare(b.time)});for(var f=0;f<d.length;f++)c+='<tr><td class="behavior-timestamp">'+d[f].time+'</td><td class="behavior-point">'+d[f].text+"</td></tr>";if(a.length>d.length){c+='</tbody><tbody class="behavior-points-hidden" style="display:none;">',a.sort(function(a,b){return a.time.localeCompare(b.time)});for(var f=0;f<a.length;f++)c+='<tr><td class="behavior-timestamp">'+a[f].time+'</td><td class="behavior-point">'+a[f].text+"</td></tr>";c+='</tbody></table></div><a class="show-all-points">(+) See all '+a.length+' observations</a><a class="show-fewer-points" style="display:none">(-) See fewer observations</a>'}else c+="</tbody></table></div>";return c}function d(b,d){map.map.openPopup(c(b.observations),a(d,b.r),{minWidth:400,maxWidth:400,fullWidth:400,className:"behavior-popup",keepInView:!1}).on("click",headerControls.closeSidePanel),headerControls.closeSidePanel()}function e(a,b){headerControls.closeSidePanel(),mediaOverlay.openOverlay(null,a.caption,a.uri,null)}return $("#map").delegate("a.show-all-points","click",function(){$("a.show-all-points").hide(),$("a.show-fewer-points").show(),$("table:visible tbody.behavior-points-hidden").show(),$("tbody.behavior-points-initial:visible").hide()}),$("#map").delegate("a.show-fewer-points","click",function(){$("a.show-fewer-points").hide(),$("a.show-all-points").show(),$("table:visible tbody.behavior-points-initial").show(),$("tbody.behavior-points-hidden:visible").hide()}),{openTextPopup:b,openBehaviorPopup:d,openPicture:e}}function initMapBubbles(){function a(){return k+=1,"WH-auto-"+k}function b(a){function b(a){var b=Math.floor(Math.random()*d.length);d.splice(b,0,a)}var c={picture:[],video:[],text:[],behavior:{}};$.each(a,function(a,b){switch(b.type){case"picture":c.picture.push(b);break;case"text":c.text.push(b);break;case"behavior":b.category in c.behavior||(c.behavior[b.category]=[]),c.behavior[b.category].push(b);break;case"start":c.start=b;break;case"end":c.end=b}});var d=[],e={};return $.each(media.categoryGroups,function(a,b){e[b]={cats:[],count:0,score:0}}),$.each(c.behavior,function(a,b){var c=e[media.categories[a].group],d=0,f=[];$.each(b,function(a,b){d+=b.score,b.tour_id&&f.push(b.tour_id)}),c.cats.push({score:d,value:Math.max(Math.min(d,70),5),type:"behaviorGroup",observations:b,cat:a,tour_ids:f}),c.count=c.count+b.length,c.score=c.score+d}),$.each(e,function(a,c){b({value:Math.max(Math.min(c.score,20),150),type:"layoutGroup",children:c.cats})}),$.each(c.picture,function(a,c){c.value=50*Math.random()+50,b(c)}),$.each(c.text,function(a,c){c.value=20*Math.random()+60,b(c)}),c.start&&(c.start.value=200,d.splice(0,0,c.start)),c.end&&(c.end.value=200,d.splice(0,0,c.end)),d}function c(a,b,c,d){var e=d.append("text").attr("text-anchor","middle"),f=2*(b-c);$.each(a.split("\\n"),function(a,b){e.append("tspan").attr({x:0,dy:0==a?0:"1.2em","text-anchor":"middle"}).text(b)});var g=e[0][0].getBBox();if(g.width>f||g.height>f)var h=f/g.width,i=f/g.height,j=i>h?h:i;else var j=1;return e.attr("transform","translate("+b+","+b+") scale("+j+")"),e}function d(a,b,d,e){switch(e.append("circle").attr("cx",b).attr("cy",b).attr("r",b),d.attr("width",2*b).attr("height",2*b),a.type){case"text":d.append("rect").attr("x",0).attr("y",0).attr("width",2*b).attr("height",2*b).attr("fill","rgba(0,0,0,0.5)"),c(a.title,b,10,d).attr("fill","white"),d.on("click",function(a,b){mapMedia.openTextPopup(a,this),d3.event.stopPropagation()});break;case"picture":d.append("image").attr("x","0").attr("y","0").attr("width",2*b).attr("height",2*b).attr("xlink:href","pictures/thumbnails/"+a.uri).attr("preserveAspectRatio","xMidYMid slice"),d.on("click",function(a,b){mapMedia.openPicture(a,this),d3.event.stopPropagation()});break;case"behaviorGroup":d.append("image").attr("x",0).attr("y",0).attr("width",2*b).attr("height",2*b).attr("xlink:href","icons/48/"+a.cat+".png").attr("preserveAspectRatio","xMidYMid slice"),d.on("click",function(a,b){mapMedia.openBehaviorPopup(a,this),d3.event.stopPropagation()});break;case"start":d.append("image").attr("x",0).attr("y",0).attr("width",2*b).attr("height",2*b).attr("xlink:href","icons/awake.png").attr("preserveAspectRatio","xMidYMid slice"),d.on("click",function(a,b){mapMedia.openTextPopup(a,this),d3.event.stopPropagation()});break;case"end":d.append("image").attr("x",0).attr("y",0).attr("width",2*b).attr("height",2*b).attr("xlink:href","icons/bedtime.png").attr("preserveAspectRatio","xMidYMid slice"),d.on("click",function(a,b){mapMedia.openTextPopup(a,this),d3.event.stopPropagation()})}a.tour_ids&&a.tour_ids.length>0&&$.each(a.tour_ids,function(a,b){tour.registerIcon(b,d[0][0])})}function e(c,e){var f=b(c),h=d3.layout.pack().sort(null).size([g,g]).padding(5),i=e.append("svg").attr("class","bubbles").attr("width",g+"px").attr("height",g+"px"),j=i.selectAll(".node").data(h.nodes({children:f}).filter(function(a){return!a.children})).enter().append("g").attr("class","node").attr("transform",function(a){return"translate("+a.x+","+a.y+")"});return j.each(function(b,c){var e=d3.select(this),f=a(),g=e.append("clipPath").attr("id",f),h=b.r,i=e.append("g").attr("width",2*h).attr("height",2*h).attr("transform","translate(-"+h+",-"+h+")").attr("clip-path","url(#"+f+")");d(b,h,i,g)}),i}function f(a,b){var c=new j;return $.each(b.behavior,function(a,b){var d={loc:b.loc,type:"behavior",time:b.time,score:b.score,category:b.cat,text:b.text};b.tour_id&&(d.tour_id=b.tour_id),c.registerMarker(d)}),$.each(a.pictures,function(a,b){var d={loc:b.loc,type:"picture",uri:b.uri,caption:b.cap};b.tour_id&&(d.tour_ids=[b.tour_id]),c.registerMarker(d)}),$.each(a.textbubbles,function(a,b){var d={loc:b.loc,type:"text",title:b.title,text:b.text};b.tour_id&&(d.tour_ids=[b.tour_id]),c.registerMarker(d)}),c.registerMarker({loc:a.WHtrack[0],type:"start",tour_ids:[0],title:a.startPopup.title,text:a.startPopup.text}),c.registerMarker({loc:a.WHtrack[a.WHtrack.length-1],type:"end",tour_ids:[a.tourlist.length-1],title:a.endPopup.title,text:a.endPopup.text}),map.map.addLayer(c),c}var g=300,h=2,i={top:10.516,bottom:10.5075,left:-85.3745,right:-85.3605},j=L.Class.extend({initialize:function(){this._layout=d3.hexbin().x(function(a){return a.loc[1]-i.left}).y(function(a){return a.loc[0]-i.top}).size([i.right-i.left,i.top-i.bottom]),this._markers=[],this._el=null},registerMarker:function(a){this._markers.push(a)},onAdd:function(a){this._map=a,this._el=d3.select(this._map.getPanes().overlayPane).append("div").attr("class","hexbin-layer leaflet-zoom-hide"),a.on("moveend",this._moveend,this),a.on("viewreset",this._reset,this),this._reset()},onRemove:function(a){a.getPanes().overlayPane.removeChild(this._el),a.off("moveend",this._moveend,this),a.off("viewreset",this._reset,this)},_reset:function(){this._createHexClusters()},_moveend:function(){var a=this._map,b=a.getBounds().pad(.25);this._el.selectAll("div.hexcluster").each(function(a,c){d3.select(this).select("svg").empty()&&b.contains([a.y+i.top,a.x+i.left])&&e(a,d3.select(this))})},_createHexClusters:function(){this._el.selectAll("div.hexcluster").remove();var a=this._map,b=(a.layerPointToLatLng(L.point(g+h,0)).lng-a.layerPointToLatLng(L.point(0,0)).lng)/2;this._layout.radius(b);this._el.selectAll("div.hexcluster").data(this._layout(this._markers)).enter().append("div").attr("class","hexcluster").style({position:"absolute",left:function(b){return a.latLngToLayerPoint([0,b.x+i.left]).x-g/2+"px"},top:function(b){return a.latLngToLayerPoint([b.y+i.top,0]).y-g/2+"px"},width:g+"px",height:g+"px"})}}),k=0;return $.getJSON("behavior.json").done(function(a){f(media,a)}),{}}function initIntroScreens(){function a(){$("#overlay-intro").fadeOut()}function b(){$("div#overlay-intro").fadeOut("slow"),headerControls.closeSidePanel(),map.map.setView(map.initialView[0],map.initialView[1],{animate:!0}),setTimeout(function(){map.startMarker.openPopup()},300)}function c(){headerControls.closeSidePanel(),mediaOverlay.closeOverlay(),map.map.closePopup(),$("div.overlay-intro-content").hide(),$("div#overlay-intro1").show(),$("div#overlay-intro").fadeIn("slow"),setTimeout(function(){map.map.setView(map.initialView[0],map.initialView[1],{animate:!0})},500)}return $(".overlay-intro-content").click(function(){return!1}),$("#next-intro1").click(function(){map.animationLineClipPadding(),a(),L.DomUtil.addClass(map.map._mapPane,"leaflet-zoom-anim-slow"),$(".leaflet-marker-pane, .leaflet-shadow-pane").fadeOut(1e3),map.map.setView([10.51185,-85.369238],16,{pan:{animate:!0,duration:1500},zoom:{animate:!0}}),window.setTimeout(function(){L.DomUtil.removeClass(map.map._mapPane,"leaflet-zoom-anim-slow")},1e3),window.setTimeout(function(){L.DomUtil.addClass(map.map._mapPane,"leaflet-zoom-anim-slow"),map.map.setView([10.51185,-85.369238],18,{pan:{animate:!0,duration:1500},zoom:{animate:!0}}),window.setTimeout(function(){L.DomUtil.removeClass(map.map._mapPane,"leaflet-zoom-anim-slow")},1e3),window.setTimeout(function(){$(".leaflet-marker-pane, .leaflet-shadow-pane").fadeIn("slow"),window.setTimeout(function(){$(".overlay-intro-content").hide(),$("#overlay-intro2").show(),$("#overlay-intro").fadeIn("slow"),map.resetLineClipPadding()},500)},1600)},3e3)}),$("#next-intro2").click(function(){map.map.setZoom(map.initialView[1],{animate:!1}),window.setTimeout(function(){a(),map.map.panTo(map.initialView[0],{animate:!0,duration:1.5,easeLinearity:1})},300),window.setTimeout(function(){map.resetLineClipPadding()},2e3)}),$("div.skip-intro, #overlay-intro").click(b),{resetIntro:c}}function initHeaderControls(){function a(a){$(a).is(":visible")?b():($(".side-panel-content").hide(),$(a).fadeIn("fast"),$("#side-panel").fadeIn("fast"),c())}function b(){$("#side-panel").fadeOut(150),d()}function c(){$("#mobile-menu-button").addClass("menu-button-open"),$("#back-to-map").fadeIn("fast")}function d(){$("#mobile-menu-button").removeClass("menu-button-open"),$("#back-to-map").fadeOut("fast")}return $("#mobile-menu-button").click(function(){return a("#panel-mobile-menu"),!1}),$("#back-to-map").click(b),$("#tab-about, #menu-about").click(function(){return a("#panel-about"),!1}),$("#tab-biographies, #menu-biographies").click(function(){return a("#panel-biographies"),!1}),$("#tab-donate, #menu-donate").click(function(){return a("#panel-donate"),!1}),$("#tab-reset, #menu-reset").click(function(){return introScreens.resetIntro(),!1}),$("#close-side-panel").click(b),$("#map *, #map, #overlay *, #overlay").click(b),{closeSidePanel:b}}function initTour(){function a(a,b){media.tourlist[a].icon=b}function b(a){var b=$(a).parents("html")[0];return!(!b||b!==document.documentElement)}var c=document.getElementById("tour-slider");return noUiSlider.create(c,{start:0,range:{min:0,max:media.tourlist.length},connect:"lower",step:1}),c.noUiSlider.on("update",function(){mediaOverlay.closeOverlay();var a=media.tourlist[Number(this.get())];a.icon&&b(a.icon)&&a.icon.dispatchEvent(new MouseEvent("click")),map.map.panTo(a.loc,{duration:.1})}),{registerIcon:a}}var map=initMap(),mediaOverlay=initMediaOverlay(),mapMedia=initMapMedia(),mapBubbles=initMapBubbles(),introScreens=initIntroScreens();headerControls=initHeaderControls(),tour=initTour();
//# sourceMappingURL=scripts.js.ugly.map