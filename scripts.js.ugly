function initMap(){function a(){var a=h;h=c.getZoom(),c.closePopup(),c.getZoom()<18?(c.removeLayer(f),c.removeLayer(d),c.removeLayer(e),c.addLayer(g)):(c.addLayer(f),c.addLayer(d),c.addLayer(e),c.removeLayer(g)),18>c.getZoom()&&c.getZoom()>6&&(c.getZoom()>a?c.setView(tour.getTourStop().loc,18):c.setZoom(6))}var b=[[10.51422,-85.36937],20],c=L.map("map",{maxZoom:20,zoomControl:!1,attributionControl:!1,maxBounds:L.latLngBounds([10.525,-85.3605],[10.5065,-85.3745])}).setView(b[0],b[1]);L.tileLayer("http://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",{maxZoom:20,maxNativeZoom:19,opacity:1}).addTo(c);var d=L.polyline(media.cabuyoPoints,{color:"lightblue",opacity:.7,weight:8,lineJoin:"round",lineCap:"round"}).addTo(c),e=L.polyline(media.pizotePoints,{color:"lightblue",opacity:.7,weight:5,lineJoin:"round",lineCap:"round"}).addTo(c),f=L.polyline(media.WHtrack,{color:"white",opacity:1,weight:5,lineJoin:"round",lineCap:"round",dashArray:[10,10]}).addTo(c);!function(){function a(a){var b=a,d=c.getSize();return b>d.x-25&&(b=d.x-25),b}var b=null;c.on("popupopen",function(c){if(b=c.popup,b.options.fullWidth){var d=a(b.options.fullWidth);d<b.options.minWidth&&(b.options.minWidth=b.options.maxWidth=d,b.update())}}),c.on("resize",function(){c.hasLayer(b)&&b.options.fullWidth&&(b.options.minWidth=b.options.maxWidth=a(b.options.fullWidth),b.update())})}(),L.control.zoom({position:"topleft"}).addTo(c),L.control.scale().addTo(c);var g=L.marker([10.5147,-85.3698],{icon:L.icon({iconUrl:"/icons/monkeyface-marker.png",iconSize:[134,160],iconAnchor:[67,160]})}).on("click",function(){c.setView(tour.getTourStop().loc,18)}),h=c.getZoom();return a(),c.on("zoomend",a),{map:c,initialView:b}}function initMediaOverlay(){function a(){$("#overlay-background").fadeOut("fast")}function b(){$("#overlay-media, #overlay-title, #overlay-bigtitle, #overlay-caption").empty().removeClass("filled"),$("#overlay-tour-next").addClass("tour-next").off("click").show()}function c(){if($("#overlay-video")){var a=$("#overlay-media").width();$("#overlay-video").attr({width:a,height:9*a/16})}}function d(a){b();var d=!1,e=!1;if(a.title&&$("#overlay-title").html(a.title).addClass("filled"),a.bigtitle&&$("#overlay-bigtitle").html(a.bigtitle).addClass("filled"),a.caption&&$("#overlay-caption").html(a.caption).addClass("filled"),a.picture){var f=$("<img>");f.on("load",function(){d=!0,e&&$("#overlay-scrollable").animate({scrollTop:$("#overlay-scrollable").prop("scrollHeight")},2e3)}),f.attr("src","pictures/"+a.picture),$("#overlay-media").append(f).addClass("filled")}if(a.video){var g=$('<iframe id="overlay-video" src="'+a.video+'" frameborder="0" width="640" height="360" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>');$("#overlay-media").append(g).addClass("filled")}a.hideNextButton&&$("#overlay-tour-next").hide(),a.nextButtonCallback&&$("#overlay-tour-next").removeClass("tour-next").on("click",a.nextButtonCallback),map.map.closePopup(),$("#overlay-background").fadeIn(400,function(){e=!0,d&&$("#overlay-scrollable").animate({scrollTop:$("#overlay-scrollable").prop("scrollHeight")},2e3)}),$("#overlay-scrollable").scrollTop(0),c()}return $("#overlay-background").click(a),$(window).on("resize",c),{openOverlay:d,closeOverlay:a}}function initMapMedia(){function a(a,b){var c=$("#map").offset(),d=$(a).offset(),e=($(a).width(),L.point(d.left-c.left+b,d.top-c.top+5));return map.map.containerPointToLatLng(e)}function b(b,c,d){map.map.openPopup('<div class="popup-title">'+b.title.replace("\\n"," ")+'</div><div class="caption">'+b.text+"</div>"+(d?"":'<div class="tour-next button-next">Next &gt;</div>'),a(c,Math.min(b.r,b.value)),{className:"behavior-popup texbox-popup",maxWidth:500,minWidth:500,fullWidth:500,keepInView:!1}).on("click",function(){headerControls.closeSidePanel()}),headerControls.closeSidePanel()}function c(a){var b=a[0].category,c='<div class="popup-title popup-title-c'+b+'">'+media.categories[b].name+' data</div><div class="behavior-list"><table><tbody class="behavior-points-initial">';a.sort(function(a,b){return b.rank-a.rank});for(var d=[],e={},f=0;f<a.length&&d.length<4;f++)e.hasOwnProperty(a[f].text)||(e[a[f].text]=!0,d.push(a[f]));d.sort(function(a,b){return a.time.localeCompare(b.time)});for(var f=0;f<d.length;f++)c+='<tr><td class="behavior-timestamp">'+d[f].time+'</td><td class="behavior-point">'+d[f].text+"</td></tr>";if(a.length>d.length){c+='</tbody><tbody class="behavior-points-hidden" style="display:none;">',a.sort(function(a,b){return a.time.localeCompare(b.time)});for(var f=0;f<a.length;f++)c+='<tr><td class="behavior-timestamp">'+a[f].time+'</td><td class="behavior-point">'+a[f].text+"</td></tr>";c+='</tbody></table></div><a class="show-all-points">(+) See all '+a.length+' observations</a><a class="show-fewer-points" style="display:none">(-) See fewer observations</a>'}else c+="</tbody></table></div>";return c+='<div class="tour-next button-next">Next &gt;</div>'}function d(b,d){map.map.openPopup(c(b.observations),a(d,b.r),{minWidth:400,maxWidth:400,fullWidth:400,className:"behavior-popup",keepInView:!1}).on("click",headerControls.closeSidePanel),headerControls.closeSidePanel()}function e(a,b){headerControls.closeSidePanel(),mediaOverlay.openOverlay({caption:a.caption,picture:a.uri})}function f(a,b){headerControls.closeSidePanel(),mediaOverlay.openOverlay({video:a.uri,caption:a.caption,title:a.title})}return $("#map").delegate("a.show-all-points","click",function(){$("a.show-all-points").hide(),$("a.show-fewer-points").show(),$("table:visible tbody.behavior-points-hidden").show(),$("tbody.behavior-points-initial:visible").hide()}),$("#map").delegate("a.show-fewer-points","click",function(){$("a.show-fewer-points").hide(),$("a.show-all-points").show(),$("table:visible tbody.behavior-points-initial").show(),$("tbody.behavior-points-hidden:visible").hide()}),{openTextPopup:b,openBehaviorPopup:d,openPicture:e,openVideo:f}}function initMapBubbles(){function a(){return o+=1,"WH-auto-"+o}function b(a){function b(a){var b=Math.floor(Math.random()*d.length);d.splice(b,0,a)}var c={picture:[],video:[],text:[],behavior:{}};$.each(a,function(a,b){switch(b.type){case"picture":c.picture.push(b);break;case"text":c.text.push(b);break;case"video":c.video.push(b);break;case"behavior":b.category in c.behavior||(c.behavior[b.category]=[]),c.behavior[b.category].push(b);break;case"start":c.start=b;break;case"end":c.end=b}});var d=[],e={};return $.each(media.categoryGroups,function(a,b){e[b]={cats:[],count:0,score:0}}),$.each(c.behavior,function(a,b){var c=e[media.categories[a].group],d=0,f=[];$.each(b,function(a,b){d+=b.score,b.tour_id&&f.push(b.tour_id)});var g=b[Math.floor(b.length/2)].time;c.cats.push({score:d,value:Math.max(Math.min(d,70),5),type:"behaviorGroup",observations:b,cat:a,tour_ids:f,time:g}),c.count=c.count+b.length,c.score=c.score+d}),$.each(e,function(a,c){b({value:Math.max(Math.min(c.score,20),150),type:"layoutGroup",children:c.cats})}),$.each(c.picture,function(a,c){c.value=50*Math.random()+80,b(c)}),$.each(c.text,function(a,c){c.value=20*Math.random()+100,b(c)}),$.each(c.video,function(a,c){c.value=50*Math.random()+80,b(c)}),c.start&&(c.start.value=200,d.splice(0,0,c.start)),c.end&&(c.end.value=200,d.splice(0,0,c.end)),d}function c(a,b,c,d){var e=d.append("text").attr("text-anchor","middle"),f=2*(b-c);$.each(a.split("\\n"),function(a,b){e.append("tspan").attr({x:0,dy:0==a?0:"1.2em","text-anchor":"middle"}).text(b)});var g=e[0][0].getBBox();if(g.width>f||g.height>f)var h=f/g.width,i=f/g.height,j=i>h?h:i;else var j=1;return e.attr("transform","translate("+b+","+b+") scale("+j+")"),e}function d(a,b,d,e){switch(e.append("circle").attr("cx",b).attr("cy",b).attr("r",b),d.attr("width",2*b).attr("height",2*b),a.type){case"text":d.append("rect").attr("x",0).attr("y",0).attr("width",2*b).attr("height",2*b).attr("fill","rgba(0,0,0,0.5)"),c(a.title,b,10,d).attr("fill","white"),d.on("click",function(a,b){mapMedia.openTextPopup(a,this),tour.updateSlider(d[0][0],a.time),d3.event.stopPropagation()});break;case"picture":d.append("image").attr("x","0").attr("y","0").attr("width",2*b).attr("height",2*b).attr("xlink:href","pictures/thumbnails/"+a.uri).attr("preserveAspectRatio","xMidYMid slice"),d.on("click",function(a,b){mapMedia.openPicture(a,this),tour.updateSlider(d[0][0],a.time),d3.event.stopPropagation()});break;case"video":d.append("image").attr("x","0").attr("y","0").attr("width",2*b).attr("height",2*b).attr("xlink:href","pictures/thumbnails/videos/"+a.thumbnail).attr("preserveAspectRatio","xMidYMid slice"),d.on("click",function(a,b){mapMedia.openVideo(a,this),tour.updateSlider(d[0][0],a.time),d3.event.stopPropagation()});break;case"behaviorGroup":d.append("image").attr("x",0).attr("y",0).attr("width",2*b).attr("height",2*b).attr("xlink:href","icons/48/"+a.cat+".png").attr("preserveAspectRatio","xMidYMid slice"),d.on("click",function(a,b){mapMedia.openBehaviorPopup(a,this),tour.updateSlider(d[0][0],a.time),d3.event.stopPropagation()});break;case"start":d.append("image").attr("x",0).attr("y",0).attr("width",2*b).attr("height",2*b).attr("xlink:href","icons/awake.png").attr("preserveAspectRatio","xMidYMid slice"),d.on("click",function(a,b){mapMedia.openTextPopup(a,this),tour.updateSlider(d[0][0],a.time),d3.event.stopPropagation()});break;case"end":d.append("image").attr("x",0).attr("y",0).attr("width",2*b).attr("height",2*b).attr("xlink:href","icons/bedtime.png").attr("preserveAspectRatio","xMidYMid slice"),d.on("click",function(a,b){mapMedia.openTextPopup(a,this,!0),tour.updateSlider(d[0][0],a.time),d3.event.stopPropagation()})}a.tour_ids&&a.tour_ids.length>0&&$.each(a.tour_ids,function(a,b){tour.registerIcon(b,d[0][0])})}function e(c,e){var f=b(c),g=d3.layout.pack().sort(null).size([k,k]).padding(10),j=e.append("svg").attr("class","bubbles").attr("width",k+"px").attr("height",k+"px"),l=j.selectAll(".node").data(g.nodes({children:f}).filter(function(a){return!a.children})).enter().append("g").attr("class","node").attr("transform",function(a){return"translate("+a.x+","+a.y+")"});return l.each(function(b,c){var e=d3.select(this),f=a(),g=e.append("clipPath").attr("id",f),j=b.r,k=e.append("g").attr("width",2*j).attr("height",2*j).attr("transform","translate(-"+j+",-"+j+")").attr("clip-path","url(#"+f+")");d(b,j,k,g),k.on("mouseover",h),k.on("mouseout",i)}),j}function f(a,b){var c=new n;return $.each(b.behavior,function(a,b){var d={loc:b.loc,type:"behavior",time:b.time,score:b.score,category:b.cat,text:b.text};b.tour_id&&(d.tour_id=b.tour_id),c.registerMarker(d)}),$.each(a.pictures,function(a,b){var d={loc:b.loc,type:"picture",uri:b.uri,caption:b.cap,time:b.time};b.tour_id&&(d.tour_ids=[b.tour_id]),c.registerMarker(d)}),$.each(a.videos,function(a,b){var d={loc:b.loc,type:"video",uri:b.uri,thumbnail:b.thumb,caption:b.cap,short_title:b.smtitle,title:b.title,time:b.time};b.tour_id&&(d.tour_ids=[b.tour_id]),c.registerMarker(d)}),$.each(a.textbubbles,function(a,b){var d={loc:b.loc,type:"text",title:b.title,text:b.text,time:b.time};b.tour_id&&(d.tour_ids=[b.tour_id]),c.registerMarker(d)}),c.registerMarker({loc:a.WHtrack[0],type:"start",tour_ids:[1],title:a.startPopup.title,text:a.startPopup.text,time:a.startPopup.time}),c.registerMarker({loc:a.WHtrack[a.WHtrack.length-1],type:"end",tour_ids:[a.tourlist.length-1],title:a.endPopup.title,text:a.endPopup.text,time:a.endPopup.time}),map.map.addLayer(c),c}function g(a){if(m){var b=m.locToCluster(a);e(b.datum(),b)}}function h(a,b,c){var d=d3.select((c?c:this).parentNode.parentNode);d.insert("circle",":first-child").classed("bubble-selection",!0).attr("fill","none").attr("r",a.r).attr("stroke","white").attr("cx",a.x).attr("cy",a.y).attr("stroke-width",0).attr("stroke-opacity",0).transition().duration(150).attr("r",a.r+2).attr("stroke-width",5).attr("stroke-opacity",1)}function i(a,b){d3.selectAll(".bubble-selection").classed("bubble-selection",!1).transition().duration(250).attr("stroke-opacity",0).attr("stroke-width",15).attr("r",function(a,b){return d3.select(this).attr("r")+20}).transition().remove()}var j=150,k=300,l={top:10.516,bottom:10.5075,left:-85.3745,right:-85.3605},m=null,n=L.Class.extend({initialize:function(){this._layout=d3.hexbin().x(function(a){return a.loc[1]-l.left}).y(function(a){return a.loc[0]-l.top}).size([l.right-l.left,l.top-l.bottom]),this._markers=[],this._hexCenters=[],this._el=null},registerMarker:function(a){this._markers.push(a)},onAdd:function(a){this._map=a,this._el=d3.select(this._map.getPanes().overlayPane).append("div").attr("class","hexbin-layer leaflet-zoom-hide"),a.on("moveend",this._moveend,this),a.on("viewreset",this._reset,this),this._reset(),this._moveend()},onRemove:function(a){a.getPanes().overlayPane.removeChild(this._el),a.off("moveend",this._moveend,this),a.off("viewreset",this._reset,this)},_reset:function(){this._createHexClusters()},_moveend:function(){var a=this._map,b=a.getBounds().pad(.25);this._el.selectAll("div.hexcluster").each(function(a,c){d3.select(this).select("svg").empty()&&b.contains([a.y+l.top,a.x+l.left])&&e(a,d3.select(this))})},_createHexClusters:function(){if(this._el.selectAll("div.hexcluster").remove(),!(this._map.getZoom()<=17)){var a=this._map,b=(a.layerPointToLatLng(L.point(k+j,0)).lng-a.layerPointToLatLng(L.point(0,0)).lng)/2;this._layout.radius(b),this._hexCenters=this._el.selectAll("div.hexcluster").data(this._layout(this._markers)).enter().append("div").attr("class","hexcluster").style({position:"absolute",left:function(b){return a.latLngToLayerPoint([0,b.x+l.left]).x-k/2+"px"},top:function(b){return a.latLngToLayerPoint([b.y+l.top,0]).y-k/2+"px"},width:k+"px",height:k+"px"})}},locToCluster:function(a){var b=this._layout([{loc:a}])[0];return this._hexCenters.filter(function(a,c){return a.i==b.i&&a.j==b.j})}}),o=0;return $.getJSON("behavior.json").done(function(a){m=f(media,a)}),{renderLoc:g}}function initIntroScreens(){function a(a){mediaOverlay.closeOverlay()}function b(){mediaOverlay.openOverlay({picture:"chew.gif",bigtitle:"Ever wonder what it's like to be a baby monkey?",caption:'This map will give you a peek into their lives, with real scientific data collected by monkey researchers.<br /><br />We can learn a lot about humans by studying monkeys &mdash; how did monkeys evolve to be so smart?  <span style="color:#555">(We should be careful not to go too far though.  Humans and monkeys are different!)</span>',nextButtonCallback:c})}function c(){setTimeout(function(){mediaOverlay.openOverlay({picture:"hello.jpg",title:"Meet Winslow Homer!",caption:"He's the star of our show.  Winslow is the alpha female's baby, so everybody wants to play with him and groom him to gain the alpha female's favor.  He loves the attention &mdash; a little prince charming!"})},300)}function d(){headerControls.closeSidePanel(),mediaOverlay.closeOverlay(),map.map.closePopup(),b(),setTimeout(function(){map.map.setView(map.initialView[0],map.initialView[1],{animate:!0})},500)}return b(),{resetIntro:d,closeIntro:a}}function initHeaderControls(){function a(a){$(a).is(":visible")?b():($(".side-panel-content").hide(),$(a).fadeIn("fast"),$("#side-panel").fadeIn("fast"),c())}function b(){$("#side-panel").fadeOut(150),d()}function c(){$("#mobile-menu-button").addClass("menu-button-open"),$("#back-to-map").fadeIn("fast")}function d(){$("#mobile-menu-button").removeClass("menu-button-open"),$("#back-to-map").fadeOut("fast")}return $("#welcome-icon").click(function(){mediaOverlay.openOverlay({caption:"Winslow Homer, a wild baby capuchin monkey",picture:"corner-welcome.jpg",hideNextButton:!0})}),$("#mobile-menu-button").click(function(){return a("#panel-mobile-menu"),!1}),$("#back-to-map").click(b),$("#tab-about, #menu-about").click(function(){return a("#panel-about"),!1}),$("#tab-biographies, #menu-biographies").click(function(){return a("#panel-biographies"),!1}),$("#tab-donate, #menu-donate").click(function(){return a("#panel-donate"),!1}),$("#tab-reset, #menu-reset").click(function(){return introScreens.resetIntro(),!1}),$("#close-side-panel").click(b),$("#map *, #map, #overlay *, #overlay").click(b),{closeSidePanel:b}}function initTour(){function a(a,b){media.tourlist[a].icon=b}function b(a){var b=$(a).parents("html")[0];return!(!b||b!==document.documentElement)}function c(){return media.tourlist[Number(h.noUiSlider.get())]}function d(){mediaOverlay.closeOverlay(),introScreens.closeIntro(),map.map.getZoom()<17&&map.map.setZoom(18);var a=c();return"intro"==a.note?void introScreens.resetIntro():(a.icon&&b(a.icon)||mapBubbles.renderLoc(a.loc),g=a.icon,void a.icon.dispatchEvent(new MouseEvent("click")))}function e(){h.noUiSlider.set(Number(h.noUiSlider.get())+1),d()}function f(a,b){if(g!==a){var c=media.tourlist.length-1;$.each(media.tourlist,function(a,d){return d.time>b?(c=Math.max(0,a-1),!1):void 0}),h.noUiSlider.set(c)}}var g=null,h=document.getElementById("tour-slider");return noUiSlider.create(h,{start:0,range:{min:0,max:media.tourlist.length-1},connect:"lower",step:1,tooltips:{to:function(a){return void 0!==a?media.tourlist[Number(a)].time.substr(0,5):""}}}),h.noUiSlider.on("slide",function(){$("#tour-slider .noUi-tooltip").show()}),h.noUiSlider.on("change",function(){$("#tour-slider .noUi-tooltip").hide()}),$("#tour-slider .noUi-tooltip").hide(),h.noUiSlider.on("change",d),$("#map-container").on("click",".tour-next",e),{registerIcon:a,updateSlider:f,tourNext:e,getTourStop:c}}var map=initMap(),mediaOverlay=initMediaOverlay(),mapMedia=initMapMedia(),mapBubbles=initMapBubbles(),introScreens=initIntroScreens();headerControls=initHeaderControls(),FontFaceOnload("Fira Sans",{success:function(){document.documentElement.className+=" fonts-loaded"}}),$(function(){FastClick.attach(document.body)}),tour=initTour();
//# sourceMappingURL=scripts.js.ugly.map